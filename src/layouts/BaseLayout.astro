---
// src/layouts/BaseLayout.astro
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import BackToTop from "../components/BackToTop.astro";
import '../styles/globals.css';

export interface Props {
  title: string;
  description: string;
  lang?: "en" | "fr";
  image?: string;
}

// Déduire la langue depuis l'URL si la prop n'est pas fournie
const path = Astro.url.pathname;
const detectedLang: "en" | "fr" = path.startsWith("/fr/") ? "fr" : "en";

const { title, description, lang, image = "/og-default.jpg" } = Astro.props;

const resolvedLang: "en" | "fr" = lang ?? detectedLang;

// URLs absolues pour SEO/OG
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = new URL(image, Astro.site);
---

<!doctype html>
<html lang={resolvedLang}>
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YS87E715NG"></script>
    <script is:inline set:html={`window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YS87E715NG');`}></script>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicons/favicon-16x16.png"
    />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>
    <link rel="canonical" href={canonicalURL} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />

    <!-- Fonts - NOUVELLE PALETTE -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Theme initialization script -->
    <script is:inline>
      (function () {
        const getStoredTheme = () => {
          try {
            return localStorage.getItem("theme");
          } catch {
            return null;
          }
        };
        const getSystemTheme = () =>
          window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        const applyTheme = (t) => {
          document.documentElement.setAttribute("data-theme", t);
          try {
            localStorage.setItem("theme", t);
          } catch {}
        };

        const stored = getStoredTheme();
        const theme =
          stored === "dark" || stored === "light" ? stored : getSystemTheme();
        applyTheme(theme);

        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        mq.addEventListener("change", (e) => {
          if (!getStoredTheme()) applyTheme(e.matches ? "dark" : "light");
        });
      })();
    </script>
  </head>
  <body>
    <!-- WRAPPER -->
    <div class="layout">
      <Header lang={resolvedLang} />

      <main class="main">
        <slot />
      </main>

      <Footer lang={resolvedLang} />
      <BackToTop />
    </div>

    <!-- Theme toggle -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const themeToggle = document.querySelector("[data-theme-toggle]");

        const updateAria = () => {
          const toggle = document.querySelector("[data-theme-toggle]");
          if (!toggle) return;
          const theme = document.documentElement.getAttribute("data-theme");
          toggle.setAttribute(
            "aria-label",
            theme === "dark" ? "Switch to light mode" : "Switch to dark mode",
          );
        };

        if (themeToggle) {
          themeToggle.addEventListener("click", function () {
            const current = document.documentElement.getAttribute("data-theme");
            const next = current === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", next);
            try {
              localStorage.setItem("theme", next);
            } catch {}
            updateAria();
          });
        }

        updateAria();
      });
    </script>
  </body>
</html>

<style is:global>
  /* ===============================
     LAYOUT & STICKY FOOTER
     =============================== */
  html,
  body {
    height: 100%;
  }
  
  body {
    margin: 0;
    background-color: rgb(var(--color-background));
    color: rgb(var(--color-text));
    line-height: 1.6;
    transition:
      background-color 250ms ease,
      color 250ms ease;
  }

  .layout {
    min-height: 100svh;
    display: flex;
    flex-direction: column;
  }

  .main {
    flex: 1 0 auto;
    min-height: calc(100vh - 120px);
  }

  /* ===============================
     THEME COLORS - DEEP BLUE ELEGANCE
     =============================== */
  :root {
    /* Couleurs principales - NOUVELLE PALETTE */
    --color-background: 5, 10, 48; /* #050a30 - Bleu foncé */
    --color-surface: 15, 25, 65; /* Bleu profond */
    --color-surface-variant: 25, 40, 90; /* Bleu moyen */

    /* Couleurs d'action - NOUVELLE PALETTE ROSE */
    --color-primary: 238, 130, 255; /* #ee82ff - Rose moins saturé (CTA) */
    --color-secondary: 245, 150, 255; /* #f596ff - Rose clair (secondary) */
    --color-primary-hover: 245, 150, 255; /* #f596ff - Rose clair (hover) */
    --color-accent: 240, 170, 255; /* #f0aaff - Rose doux (accents) */

    /* Textes - NOUVELLE PALETTE */
    --color-text: 232, 234, 240; /* #E8EAF0 - Blanc cassé */
    --color-text-muted: 156, 163, 184; /* #9CA3B8 - Gris-bleu */
    --color-text-inverse: 10, 22, 40; /* Bleu foncé pour texte sur fond clair */

    /* Bordures & séparateurs - NOUVELLE PALETTE */
    --color-border: 25, 40, 90; /* Bleu moyen */
    --color-border-muted: 15, 25, 65; /* Bleu profond */

    /* Statuts */
    --color-success: 16, 185, 129; /* #10B981 - Vert validation */
    --color-warning: 251, 191, 36;
    --color-error: 239, 68, 68;

    --color-shadow: 0, 0, 0;

    /* Typographie - NOUVELLE PALETTE */
    --font-logo: "Space Grotesk", sans-serif;
    --font-hero: "Space Grotesk", sans-serif; /* H1 Hero */
    --font-heading: "Inter", sans-serif; /* H2, H3 */
    --font-serif: "Inter", sans-serif;
    --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    --font-mono: "JetBrains Mono", "Menlo", "Monaco", "Courier New", monospace;

    /* Espacements */
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    --space-3xl: 4rem;

    /* Bordures arrondies */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 1rem;
    --radius-xl: 1.5rem;

    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
  }

  /* Mode sombre déjà actif par défaut avec la palette Deep Blue */
  /* Pas besoin de [data-theme="dark"] car le fond est déjà sombre */

  /* ===============================
     BASE STYLES
     =============================== */
  * {
    box-sizing: border-box;
  }
  
  html {
    font-family: var(--font-sans);
    scroll-behavior: smooth;
    font-size: 16px;
  }

  /* ===============================
     TYPOGRAPHY
     =============================== */
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-weight: 600;
    line-height: 1.2;
    margin-top: 0;
    color: rgb(var(--color-text));
  }
  
  h1 {
    font-family: var(--font-hero);
    font-size: clamp(2.5rem, 5vw, 4.5rem);
    font-weight: 700;
  }
  
  h2 {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 700;
  }
  
  h3 {
    font-family: var(--font-heading);
    font-size: clamp(1.5rem, 3vw, 2rem);
    font-weight: 600;
  }
  
  h4 {
    font-size: 1.5rem;
    font-weight: 500;
  }
  
  h5 {
    font-size: 1.25rem;
    font-weight: 500;
  }
  
  h6 {
    font-size: 1.125rem;
    font-weight: 500;
  }
  
  p {
    margin-top: 0;
    margin-bottom: 1rem;
    color: rgb(var(--color-text-muted));
  }

  /* ===============================
     LINKS
     =============================== */
  a {
    color: rgb(var(--color-primary));
    text-decoration: none;
    transition: opacity var(--transition-fast);
  }
  
  a:hover {
    opacity: 0.85;
  }

  /* ===============================
     BUTTONS - NOUVELLE PALETTE
     =============================== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0.875rem 1.75rem;
    border: none;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-normal);
    white-space: nowrap;
    position: relative;
    overflow: hidden;
    gap: 0.5rem;
  }

  .btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.2),
      transparent
    );
    transition: left 0.5s;
  }
  
  .btn:hover::before {
    left: 100%;
  }

  .btn-primary {
    background: linear-gradient(
      135deg,
      rgb(var(--color-primary)),
      rgb(var(--color-primary-hover))
    );
    color: white;
    box-shadow: 0 4px 15px rgba(var(--color-primary), 0.3);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(var(--color-primary), 0.4);
    opacity: 1;
  }

  .btn-secondary {
    background: transparent;
    color: rgb(var(--color-text));
    border: 2px solid rgba(var(--color-border), 1);
  }
  
  .btn-secondary:hover {
    background: rgba(var(--color-surface-variant), 0.5);
    border-color: rgb(var(--color-primary));
    transform: translateY(-2px);
    opacity: 1;
  }

  .btn-large {
    padding: 1.125rem 2.5rem;
    font-size: 1.125rem;
  }

  /* ===============================
     CONTAINER
     =============================== */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  @media (max-width: 1024px) {
    .container {
      padding: 0 1.5rem;
    }
  }

  @media (max-width: 600px) {
    .container {
      padding: 0 1rem;
    }
  }

  /* ===============================
     SECTION TITLES
     =============================== */
  .section-title {
    text-align: center;
    margin-bottom: 2rem;
    color: rgb(var(--color-text));
    font-family: var(--font-heading);
  }

  /* ===============================
     CODE BLOCKS
     =============================== */
  pre,
  code {
    font-family: var(--font-mono);
    background: rgba(var(--color-surface-variant), 0.5);
    border-radius: var(--radius-sm);
  }
  
  pre {
    padding: 1rem;
    overflow-x: auto;
    line-height: 1.5;
  }
  
  code:not(pre code) {
    padding: 0.2rem 0.4rem;
    font-size: 0.875em;
    color: rgb(var(--color-accent));
  }

  /* ===============================
     FOCUS STYLES (ACCESSIBILITÉ)
     =============================== */
  :focus-visible {
    outline: 2px solid rgb(var(--color-primary));
    outline-offset: 2px;
  }

  /* ===============================
     REDUCED MOTION
     =============================== */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* ===============================
     PRINT
     =============================== */
  @media print {
    .no-print {
      display: none !important;
    }
  }

  /* ===============================
     MOBILE : CENTRAGE SANS LARGEUR FORCÉE
     =============================== */
  @media (max-width: 768px) {
    .btn {
      justify-content: center;
      text-align: center;
      width: auto;
      max-width: 100%;
    }

    .btn--full {
      width: 100%;
      display: flex;
    }

    .cta-buttons {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
  }

  /* ===============================
     GRADIENT TEXT UTILITY
     =============================== */
  .gradient-text {
    background: linear-gradient(135deg, rgb(var(--color-primary)), rgb(var(--color-primary-hover)));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
  }

  /* ===============================
     SCROLLBAR CUSTOM
     =============================== */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(var(--color-border), 0.1);
    border-radius: var(--radius-sm);
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(var(--color-primary), 0.3);
    border-radius: var(--radius-sm);
    border: 2px solid transparent;
    background-clip: content-box;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(var(--color-primary), 0.6);
    background-clip: content-box;
  }

  ::-webkit-scrollbar-corner {
    background: rgba(var(--color-border), 0.1);
  }
</style>